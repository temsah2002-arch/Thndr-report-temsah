<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Thndr â€” Dashboard</title>

  <!-- Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ -->
  <link rel="stylesheet" href="assets/ui.css">

  <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®ÙÙŠÙØ© Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø· -->
  <style>
    :root{
      --bg:#0b0b0f;--card:#14141b;--soft:#0f1016;--border:#23242c;
      --txt:#f3f4f6;--muted:#a1a1aa;--acc:#0ea5e9;--good:#22c55e;--bad:#ef4444
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:"Cairo",Tahoma,Arial,sans-serif}
    .container{max-width:1200px;margin:22px auto;padding:0 16px}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .small{color:var(--muted);font-size:12px}
    .pos{color:var(--good);font-weight:700}
    .neg{color:var(--bad);font-weight:700}
    .card--noPad{padding:0}
    .mt-8{margin-top:8px}
    .mt-12{margin-top:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .kpi{display:flex;justify-content:space-between;align-items:center;background:var(--soft);border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi b{font-size:18px}
    .table{width:100%;border-collapse:collapse;background:var(--soft);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-size:14px}
    .table th{background:#101118;color:#cbd5e1}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
  <div class="container">
    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div class="header">
      <div class="title">Ù„ÙˆØ­Ø© Ø«Ø§Ù†Ø¯Ø± â€” Dashboard</div>
      <div id="date" class="chip">â€”</div>
<div class="toolbar">
  <a class="btn" href="report/portfolio_report.html">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</a>
  <a class="btn" href="plan/">ğŸ’° Ø®Ø·Ø© Ø¥ÙŠØ¯Ø§Ø¹ 24</a>
  <a class="btn btn--soft" href="report/#CALC">ğŸ§® Ø­Ø§Ø³Ø¨Ø© ØªØ¯Ø§ÙˆÙ„</a>
</div>
    </div>

    <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ù…Ù„Ø®Øµ + ØªÙˆØ²ÙŠØ¹ -->
    <div class="grid two">
      <!-- ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ´Ø±ÙŠØ· Ø§Ù„Ø³ÙˆÙ‚ -->
      <div class="card">
        <div class="grid two" id="stats"></div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­ÙŠ -->
        <div class="row mt-8">
          <span class="chip">EGX30: <b id="egx30_val">â€”</b></span>
          <span class="chip">EGX70: <b id="egx70_val">â€”</b></span>
          <span class="chip">Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±: <b id="usd_val">â€”</b></span>
        </div>

        <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© + Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
<div class="row mt-8">
  <a class="btn" href="report/">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</a>
  <a class="btn" href="plan/">Ø®Ø·Ø© Ø¥ÙŠØ¯Ø§Ø¹ 24</a>
  <a class="btn btn--soft" href="report/#CALC">Ø­Ø§Ø³Ø¨Ø© ØªØ¯Ø§ÙˆÙ„</a>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
  <button class="btn" id="btnUpdate">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…</button>
  <button class="btn btn--soft" id="btnToken">ğŸ” Ø¶Ø¨Ø· GitHub Token</button>
</div>

      <!-- ÙƒØ§Ø±Øª ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø© -->
      <div class="card">
        <div class="small" style="font-weight:700;margin-bottom:6px">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
        <canvas id="alloc" height="280"></canvas>
        <div id="allocLegend" class="small" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- ÙƒØ§Ø±Øª EGX30 Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
    <div class="card">
      <div class="small" style="font-weight:700;margin-bottom:6px">EGX30 â€” Ù…Ø¨Ø§Ø´Ø±</div>
      <div id="egx" style="height:380px"></div>
      <div class="small">Ø¥Ù† Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ø³Ù… Ø¬Ø±Ù‘Ø¨ Ø´Ø¨ÙƒØ© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§ÙØªØ­Ù‡ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² -->
    <div class="card card--noPad mt-12">
      <table class="table" id="pos">
        <thead>
          <tr>
            <th>Ø§Ù„Ø³Ù‡Ù…</th><th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th><th>Ù…ØªÙˆØ³Ø·</th><th>Ø¢Ø®Ø±</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const fmt = (n,d=2)=> new Intl.NumberFormat('ar-EG',{maximumFractionDigits:d}).format(+n||0);
    const pct = n => ( (n>=0?'+':'') + (Number(n)||0).toFixed(2) + '%' );
    const REFRESH_MS = 5*60*1000; // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚

    async function renderAll(){
      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©
      const p = await fetch('data/portfolio.json?_=' + Date.now()).then(r=>r.json());

      // Ø§Ù„ØªØ§Ø±ÙŠØ®
      document.getElementById('date').textContent =
        new Date(p.as_of||Date.now()).toLocaleDateString('ar-EG',{day:'numeric',month:'long',year:'numeric'});

      // Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù„ÙˆÙŠ
      document.getElementById('stats').innerHTML = `
        <div class="kpi"><span>Ù‚ÙŠÙ…Ø© Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ</span><b id="pf_value">${fmt(p.portfolio_value)}</b></div>
        <div class="kpi"><span>ØªØºÙŠØ± Ø§Ù„ÙŠÙˆÙ…</span>
          <b id="pf_day" class="${p.day_change>=0?'pos':'neg'}">
            ${fmt(p.day_change)} (${pct(p.day_change_pct)})
          </b>
        </div>`;

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²
      const tb = document.querySelector('#pos tbody');
      tb.innerHTML = (p.positions||[]).map(x=>`
        <tr>
          <td><b>${x.ticker}</b> â€” <span class="small">${x.name||''}</span></td>
          <td>${fmt(x.units,0)}</td>
          <td>${fmt(x.avg_price)}</td>
          <td>${fmt(x.last)}</td>
          <td>${fmt(x.market_value)}</td>
          <td class="${x.pnl>=0?'pos':'neg'}">${fmt(x.pnl)} (${pct(x.pnl_pct)})</td>
        </tr>`).join('');

      // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©
      const labels = (p.positions||[]).map(x=>x.ticker);
      const data   = (p.positions||[]).map(x=>+x.market_value||0);
      const total  = data.reduce((a,b)=>a+b,0)||1;
      const per    = data.map(v=> v/total*100);

      if(window.allocChart) window.allocChart.destroy();
      window.allocChart = new Chart(document.getElementById('alloc').getContext('2d'),{
        type:'doughnut',
        data:{labels, datasets:[{data, borderWidth:0}]},
        options:{plugins:{legend:{display:false}}, cutout:'60%'}
      });
      document.getElementById('allocLegend').innerHTML =
        labels.map((l,i)=>`${l}: ${fmt(per[i])}%`).join(' â€¢ ');

      // Ù…Ø®Ø·Ø· EGX30 (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
      if(!window.egxMounted && window.TradingView){
        new TradingView.widget({
          container_id:"egx", autosize:true, symbol:"EGX:EGX30",
          interval:"60", timezone:"Africa/Cairo", theme:"dark", style:"1",
          hide_top_toolbar:true, withdateranges:false, hide_legend:true,
          hide_volume:true, studies:[], locale:"ar"
        });
        window.egxMounted = true;
      }

      // Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙˆÙ‚
      await updateMarketBar();
    }

    async function updateMarketBar(){
      try{
        const j = await fetch('data/market.json?_=' + Date.now()).then(r=>r.json());
        const set = (id, val)=>{
          const el = document.getElementById(id);
          if(!el) return;
          el.textContent = (val>=0?'+':'') + Number(val||0).toFixed(2) + '%';
          el.className = val>=0 ? 'pos' : 'neg';
        };
        set('egx30_val', j?.egx30?.chg_pct ?? 0);
        set('egx70_val', j?.egx70?.chg_pct ?? 0);
        const usd = document.getElementById('usd_val');
        if(usd) usd.textContent = Number(j?.usd_egp ?? 0).toFixed(2) + ' Ø¬';
      }catch(e){ console.warn('market.json error', e); }
    }

    // ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ
    renderAll();
    setInterval(renderAll, REFRESH_MS);
  </script>
    <script>
/* ========= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù† ========== */
const GH = {
  owner: "temsah2002-arch",             // Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨
  repo:  "Thndr-report-temsah",         // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
  branch:"main",                        // Ø§Ù„ÙØ±Ø¹
  paths: {
    portfolio: "data/portfolio.json",
    dailylog:  "data/daily_log.json"
  }
};

/* ====== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ====== */
const b64 = s => btoa(unescape(encodeURIComponent(s)));
const deB64 = s => decodeURIComponent(escape(atob(s)));

/* Ù‚Ø±Ø§Ø¡Ø©/Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§ */
function getToken(){ return localStorage.getItem("gh_token") || ""; }
function setToken(t){ localStorage.setItem("gh_token", t.trim()); }

/* Ø¬Ù„Ø¨ Ù…Ù„Ù Ù…Ù† GitHub (API contents) */
async function ghRead(path){
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}?ref=${GH.branch}`;
  const r = await fetch(url, {headers:{Accept:"application/vnd.github+json"}});
  if(!r.ok) throw new Error("Read failed: "+path);
  const j = await r.json();
  return { sha:j.sha, text: deB64(j.content||"") };
}

/* ÙƒØªØ§Ø¨Ø© Ù…Ù„Ù Ø¥Ù„Ù‰ GitHub */
async function ghWrite(path, content, sha, message){
  const token = getToken();
  if(!token) throw new Error("NO_TOKEN");
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
  const body = {
    message,
    content: b64(content),
    sha,
    branch: GH.branch
  };
  const r = await fetch(url, {
    method:"PUT",
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization":"Bearer "+token
    },
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t = await r.text();
    throw new Error("Write failed: "+t);
  }
  return r.json();
}

/* ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø© */
function downloadFile(name, text){
  const a=document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:'application/json'}));
  a.download = name; a.click();
}

/* Ø¨Ù†Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙÙŠÙ† */
async function doUpdate(){
  // Ø§Ù‚Ø±Ø£ Ù…Ù„ÙÙŠ JSON Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
  const pf = await fetch('data/portfolio.json?_='+Date.now()).then(r=>r.json());
  const logObj = await fetch('data/daily_log.json?_='+Date.now()).then(r=>r.json());

  // ØªØ­Ø¶ÙŠØ± Ù‚ÙŠÙ… Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ù€ portfolio.json (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸)
  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const best = (pf.positions||[]).slice().sort((a,b)=> (b.pnl_pct||0)-(a.pnl_pct||0))[0]?.ticker || "";
  const worst= (pf.positions||[]).slice().sort((a,b)=> (a.pnl_pct||0)-(b.pnl_pct||0))[0]?.ticker || "";

  const entry = {
    date: today,
    portfolio_value: +(pf.portfolio_value||0),
    day_change: +(pf.day_change||0),
    day_change_pct: +(pf.day_change_pct||0),
    best_stock: best,
    worst_stock: worst,
    notes: "ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ù„ÙˆØ­Ø© Thndr."
  };

  // Ø­Ø¯Ø« daily_log.json (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù†ÙØ³ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…)
  const entries = Array.isArray(logObj.entries) ? logObj.entries : [];
  const idx = entries.findIndex(e => e.date === today);
  if(idx>=0) entries[idx] = entry; else entries.push(entry);
  const newLog = JSON.stringify({as_of: today, entries}, null, 2);

  // portfolio.json ÙƒÙ…Ø§ Ù‡Ùˆ (Ø£Ù†Øª Ø­Ø¯Ù‘Ø«ØªÙ‡ Ù…Ù† ØµÙˆØ± Ø«Ø§Ù†Ø¯Ø± Ø¨Ø§Ù„ÙØ¹Ù„)
  const newPf  = JSON.stringify(pf, null, 2);

  // Ø¬Ø±Ù‘Ø¨ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± GitHubØ› ÙˆØ¥Ù† ÙØ´Ù„Øª (Ù„Ø§ ØªÙˆÙƒÙ†) Ù†Ø²Ù‘Ù„ Ù…Ù„ÙÙŠÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§
  try{
    const pr = await ghRead(GH.paths.portfolio);
    const lr = await ghRead(GH.paths.dailylog);

    await ghWrite(GH.paths.portfolio, newPf, pr.sha, `chore: update portfolio ${today}`);
    await ghWrite(GH.paths.dailylog,  newLog, lr.sha, `chore: append daily_log ${today}`);

    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø¹Ù„Ù‰ GitHub âœ…");
    location.reload();
  }catch(e){
    if(e.message==="NO_TOKEN"){
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Token â€” Ø³ÙŠØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ù…Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
    }else{
      console.warn(e);
      alert("ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¨Ø± GitHub â€” Ø³ÙŠØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§.");
    }
    downloadFile("portfolio.json", newPf);
    downloadFile("daily_log.json", newLog);
  }
}

/* Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
document.getElementById('btnUpdate').addEventListener('click', doUpdate);
document.getElementById('btnToken').addEventListener('click', ()=>{
  const t = prompt("Ø£Ø¯Ø®Ù„ GitHub Token (scope: repo, workflow) â€” Ø³ÙŠÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§:");
  if(t) setToken(t);
  alert(getToken() ? "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…" : "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸.");
});
</script>
</body>
</html>
