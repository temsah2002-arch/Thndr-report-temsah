<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>التقرير اليومي — محفظة ثاندر</title>

<!-- (اختياري) إن كان لديك ملف أنماط عام -->
<link rel="stylesheet" href="../assets/ui.css">

<style>
:root{--bg:#0b0b0f;--card:#14141b;--soft:#0f1016;--border:#23242c;--txt:#f3f4f6;--muted:#a1a1aa;--acc:#0ea5e9;--good:#22c55e;--bad:#ef4444}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--txt);font-family:"Cairo",Tahoma,Arial,sans-serif}
.container{max-width:1200px;margin:22px auto;padding:0 16px}
.header{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:12px}
.title{font-size:26px;font-weight:800}
.chip{background:var(--card);border:1px solid var(--border);color:#cbd5e1;padding:6px 12px;border-radius:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-block;background:var(--acc);color:#fff;border:0;border-radius:12px;padding:10px 14px;text-decoration:none}
.btn--soft{background:#2e2f39}
.grid{display:grid;gap:12px}.two{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.stat{display:flex;justify-content:space-between;align-items:center;background:var(--soft);border:1px solid var(--border);border-radius:14px;padding:12px}
.stat b{font-size:18px}
.small{color:var(--muted);font-size:12px}
.table{width:100%;border-collapse:collapse;background:var(--soft);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-size:14px}
.table th{background:#101118;color:#cbd5e1}
.pos{color:var(--good);font-weight:700}
.neg{color:var(--bad);font-weight:700}
.badge{display:inline-block;background:#101118;border:1px solid var(--border);color:#cbd5e1;border-radius:999px;padding:2px 10px;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="title">التقرير اليومي — محفظة ثاندر</div>
    <div class="chip" id="asof">—</div>
    <div class="toolbar" style="margin-inline-start:auto">
      <a class="btn btn--soft" href="../">Dashboard</a>
      <a class="btn btn--soft" href="#summary">الملخص</a>
      <a class="btn btn--soft" href="../watchlist/">قائمة المراقبة</a>
      <a class="btn" href="#CALC">حاسبة</a>
    </div>
  </div>

  <!-- Summary cards -->
  <div id="summary" class="grid two">
    <div class="card">
      <div class="grid two">
        <div class="stat"><span>قيمة استثماري</span><b id="pf_val">—</b></div>
        <div class="stat"><span>تغير اليوم</span><b id="pf_day">—</b></div>
      </div>
      <div class="small" style="margin-top:8px">
        الأرقام تُسحب من <code>data/portfolio.json</code> ويتم التحديث كل 5 دقائق.
      </div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">مؤشرات</div>
      <div class="grid two">
        <div class="stat"><span>EGX30</span><b id="egx30" class="pos">+0.00%</b></div>
        <div class="stat"><span>EGX70</span><b id="egx70" class="neg">-0.00%</b></div>
      </div>
      <div class="stat" style="margin-top:8px"><span>الدولار</span><b id="usd">— ج</b></div>
    </div>
  </div>

  <!-- Positions table -->
  <div class="card" style="padding:0;margin-top:12px">
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>السهم</th>
          <th>النوع</th>
          <th>الوحدات</th>
          <th>متوسط</th>
          <th>آخر</th>
          <th>القيمة</th>
          <th>الربح/الخسارة</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="5">الإجمالي</th>
          <th id="sum_mv">—</th>
          <th id="sum_pnl">—</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Calculator anchor (يتم فتحها من نفس الصفحة أو صفحة التقرير الحالية) -->
  <div id="CALC" class="card">
    <div style="font-weight:700;margin-bottom:6px">حاسبة تداول سريعة</div>
    <div class="grid two">
      <label class="stat"><span>سعر الدخول</span><input id="c_entry" class="chip" type="number" step="0.01" style="min-width:120px"></label>
      <label class="stat"><span>رأس المال (ج)</span><input id="c_cap" class="chip" type="number" step="1" value="5000" style="min-width:120px"></label>
    </div>
    <div class="grid two" style="margin-top:8px">
      <label class="stat"><span>مخاطرة %</span><input id="c_risk" class="chip" type="number" step="0.1" value="1.5" style="min-width:120px"></label>
      <label class="stat"><span>هدف 1 (ج)</span><input id="c_t1" class="chip" type="number" step="0.01" style="min-width:120px"></label>
    </div>
    <div class="stat" style="margin-top:8px"><span>وحدات مقترحة</span><b id="c_units">—</b></div>
    <div class="small">غيّر القيم بالأعلى وسيتم الحساب فورًا.</div>
  </div>
</div>

<script>
const fmt=(n,d=2)=>new Intl.NumberFormat('ar-EG',{maximumFractionDigits:d}).format(+n||0);
const pct=(n)=>((n>=0?'+':'')+(+n).toFixed(2)+'%');
const REFRESH_MS = 5*60*1000;

async function loadAll(){
  const [p, m] = await Promise.all([
    fetch('../data/portfolio.json?_='+Date.now()).then(r=>r.json()),
    fetch('../data/market.json?_='+Date.now()).then(r=>r.json()).catch(()=>({}))
  ]);

  // Header date
  document.getElementById('asof').textContent =
    new Date(p.as_of||Date.now()).toLocaleDateString('ar-EG',{day:'numeric',month:'long',year:'numeric'});

  // Summary
  document.getElementById('pf_val').textContent = fmt(p.portfolio_value);
  const dy = +p.day_change||0, dyp = +p.day_change_pct||0;
  const pfDay = document.getElementById('pf_day');
  pfDay.innerHTML = `${fmt(dy)} (${pct(dyp)})`;
  pfDay.className = dy>=0 ? 'pos' : 'neg';

  // Indices
  if(m && m.egx30) {
    const e30=document.getElementById('egx30');
    const e70=document.getElementById('egx70');
    e30.textContent = pct(m.egx30.chg_pct||0); e30.className = (m.egx30.chg_pct>=0)?'pos':'neg';
    e70.textContent = pct(m.egx70.chg_pct||0); e70.className = (m.egx70.chg_pct>=0)?'pos':'neg';
    document.getElementById('usd').textContent = (m.usd_egp??0).toFixed(2)+' ج';
  }

  // Table
  const rows = (p.positions||[]).map(x=>({
    ticker:x.ticker, name:x.name||'', type:x.type||'stock',
    units:+x.units||0, avg:+x.avg_price||0, last:+x.last||0,
    mv:+x.market_value||((+x.last||0)*(+x.units||0)),
    pnl:(x.pnl!=null)?+x.pnl:((+x.last - +x.avg_price)*(+x.units||0)),
    pnl_pct:(x.pnl_pct!=null)?+x.pnl_pct:(((+x.last - +x.avg_price)/((+x.avg_price)||1))*100)
  }));

  const tb=document.querySelector('#tbl tbody');
  tb.innerHTML = rows.map(r=>{
    const cls = r.pnl>=0?'pos':'neg';
    return `<tr>
      <td><b>${r.ticker}</b> — <span class="small">${r.name}</span></td>
      <td><span class="badge">${r.type==='fund'?'صندوق':'سهم'}</span></td>
      <td>${fmt(r.units,0)}</td>
      <td>${fmt(r.avg)}</td>
      <td>${fmt(r.last)}</td>
      <td>${fmt(r.mv)}</td>
      <td class="${cls}">${fmt(r.pnl)} (${pct(r.pnl_pct)})</td>
    </tr>`;
  }).join('');

  // Footer totals
  const sum_mv = rows.reduce((a,b)=>a+b.mv,0);
  const sum_pnl = rows.reduce((a,b)=>a+b.pnl,0);
  document.getElementById('sum_mv').textContent = fmt(sum_mv);
  const sumEl=document.getElementById('sum_pnl');
  sumEl.textContent = fmt(sum_pnl);
  sumEl.className = sum_pnl>=0?'pos':'neg';
}

function bindCalc(){
  const entry = document.getElementById('c_entry');
  const cap = document.getElementById('c_cap');
  const risk = document.getElementById('c_risk');
  const t1 = document.getElementById('c_t1');
  const out = document.getElementById('c_units');
  const recalc=()=>{
    const e=+entry.value||0, c=+cap.value||0, r=(+risk.value||0)/100;
    const riskAmount = c*r;
    const stop = e * (1 - r); // افتراض إيقاف عند نسبة المخاطرة من سعر الدخول
    const perShareRisk = Math.max(e-stop, 0.01);
    const units = perShareRisk>0 ? Math.floor(riskAmount / perShareRisk) : 0;
    out.textContent = fmt(units,0);
    if(!t1.value && e) t1.value = (e * 1.12).toFixed(2); // هدف افتراضي 12%
  };
  [entry,cap,risk,t1].forEach(el=>el.addEventListener('input',recalc));
  recalc();
}

loadAll();
bindCalc();
setInterval(loadAll, REFRESH_MS);
</script>
</body>
</html>
