<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª</title>
<link rel="stylesheet" href="../assets/ui.css">
<style>
  :root{--bg:#0b0b0f;--card:#14141b;--soft:#0f1016;--border:#23242c;--txt:#f3f4f6;--muted:#a1a1aa;--acc:#0ea5e9;--good:#22c55e;--bad:#ef4444}
  body{background:var(--bg);color:var(--txt);font-family:"Cairo",Tahoma,Arial,sans-serif;margin:0}
  .container{max-width:1100px;margin:22px auto;padding:0 16px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .kpi{background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center}
  .kpi b{font-size:18px}
  .small{color:var(--muted);font-size:12px}
  .pos{color:var(--good);font-weight:700}
  .neg{color:var(--bad);font-weight:700}
  .table{width:100%;border-collapse:collapse;background:var(--soft);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-size:14px}
  .table th{background:#101118;color:#cbd5e1}
  .badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;display:inline-block}
  .badge--pos{background:rgba(34,197,94,.12);color:var(--good)}
  .badge--neg{background:rgba(239,68,68,.12);color:var(--bad)}
  .btn--ghost{background:transparent;border:1px dashed var(--border)}
  .hint{font-size:12px;color:#94a3b8}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">

  <div class="row" style="justify-content:space-between;gap:12px">
    <div class="row" style="gap:8px">
      <a class="btn" href="../">â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø©</a>
      <a class="btn" href="./portfolio_report.html">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</a>
    </div>
    <div class="chip" id="chipDate">Ø§Ù„ØªØ§Ø±ÙŠØ®: â€”</div>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø£Ø¹Ù„Ù‰ -->
  <div class="grid two">
    <div class="card">
      <div class="grid two" id="kpis"></div>
      <div class="row" style="margin-top:10px">
        <span class="chip">Ø£ÙØ¶Ù„ Ø§Ù„ÙŠÙˆÙ…: <b id="best">â€”</b></span>
        <span class="chip">Ø£Ø¶Ø¹Ù Ø§Ù„ÙŠÙˆÙ…: <b id="worst">â€”</b></span>
      </div>
    </div>
    <div class="card">
      <div class="small" style="font-weight:700;margin-bottom:6px">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
      <canvas id="alloc" height="260"></canvas>
      <div id="legend" class="small" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² -->
  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="small" style="font-weight:700">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
      <div class="row">
        <input id="sessionDate" type="date" class="chip" />
        <button id="saveLog" class="btn btn--soft">ğŸ’¾ Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      </div>
    </div>
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Ø§Ù„Ø±Ù…Ø²</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ­Ø¯Ø§Øª</th><th>Ù…ØªÙˆØ³Ø·</th><th>Ø¢Ø®Ø±</th>
          <th>Ù‚ÙŠÙ…Ø©</th><th>PnL</th><th>Ùª</th><th>Ø§Ù„ØªÙˆØµÙŠØ©</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="hint" style="margin-top:6px">Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¢Ù„ÙŠØ© Ù„Ù„ØªÙˆØµÙŠØ©: ØªØ¹Ø²ÙŠØ² Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ²Ù† Ø£Ù‚Ù„ Ù…Ù† 15% Ùˆ/Ø£Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ â‰¥ 0.5%ØŒ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† -6%ØŒ ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ù„Ù„Ø¨Ø§Ù‚ÙŠ.</div>
  </div>

  <!-- ØªÙˆØµÙŠØ§Øª Ù…Ø®ØªØµØ±Ø© -->
  <div class="card">
    <div class="small" style="font-weight:700;margin-bottom:8px">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØµÙŠØ§Øª</div>
    <div id="recs" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
  </div>

  <!-- Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ÙŠÙˆÙ… -->
  <div class="card">
    <div class="small" style="font-weight:700;margin-bottom:8px">Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</div>
    <textarea id="note" rows="3" class="input" style="width:100%;background:var(--soft);border:1px solid var(--border);color:var(--txt);border-radius:10px;padding:10px"
      placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©.. Ù…Ø«Ø§Ù„: ØªÙ… Ø¨ÙŠØ¹ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ 14.77 â€“ ØªØ¹Ø²ÙŠØ² Ù…Ù‚ØªØ±Ø­ Ù„Ù€ COMI Ùˆ BMMØŒ Ù…Ø±Ø§Ù‚Ø¨Ø© BSB."></textarea>
    <div class="row" style="margin-top:8px">
      <button id="btnToken" class="btn btn--ghost">ğŸ” Ø¶Ø¨Ø· GitHub Token</button>
      <span class="hint">Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub ÙŠØ­ØªØ§Ø¬ Token (scope: repo). ÙŠÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</span>
    </div>
  </div>

</div>

<script>
const fmt=(n,d=2)=>new Intl.NumberFormat('ar-EG',{maximumFractionDigits:d}).format(+n||0);
const pct=n=>((n>=0?'+':'')+(Number(n)||0).toFixed(2)+'%');

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
const GH={owner:'temsah2002-arch',repo:'Thndr-report-temsah',branch:'main',
  paths:{pf:'data/portfolio.json',log:'data/daily_log.json'}};
const b64=s=>btoa(unescape(encodeURIComponent(s)));
const deB64=s=>decodeURIComponent(escape(atob(s)));
const getToken=()=>localStorage.getItem('gh_token')||'';
const setToken=t=>localStorage.setItem('gh_token',t.trim());

async function ghRead(path){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}?ref=${GH.branch}`;
  const r=await fetch(url,{headers:{Accept:'application/vnd.github+json'}});
  if(!r.ok) throw new Error('read '+path);
  const j=await r.json(); return {sha:j.sha,text:deB64(j.content||'')};
}
async function ghWrite(path,content,sha,msg){
  const tok=getToken(); if(!tok) throw new Error('NO_TOKEN');
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
  const body={message:msg,content:b64(content),sha,branch:GH.branch};
  const r=await fetch(url,{method:'PUT',headers:{Accept:'application/vnd.github+json','Authorization':'Bearer '+tok},body:JSON.stringify(body)});
  if(!r.ok){const t=await r.text(); throw new Error('write '+t)}
  return r.json();
}

function decideAction(item,weight){
  // Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø³ÙŠØ·Ø©:
  // - ØªØ¹Ø²ÙŠØ² Ø¥Ø°Ø§ Ø§Ù„ÙˆØ²Ù† < 15% Ø£Ùˆ pnl_pct Ø¨ÙŠÙ† -3% Ùˆ +4% Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ
  // - Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø°Ø§ pnl_pct <= -6%
  // - Ø§Ø­ØªÙØ§Ø¸ Ù„Ù„Ø¨Ø§Ù‚ÙŠ
  if((weight<15 && (item.pnl_pct||0)>-6) || (item.pnl_pct||0)>=0.5) return {tag:'ØªØ¹Ø²ÙŠØ²', cls:'badge--pos'};
  if((item.pnl_pct||0)<=-6) return {tag:'Ù…Ø±Ø§Ù‚Ø¨Ø©', cls:'badge--neg'};
  return {tag:'Ø§Ø­ØªÙØ§Ø¸', cls:''};
}

let PF={}, LOG={};

async function render(){
  PF = await fetch('../'+GH.paths.pf+'?_='+Date.now()).then(r=>r.json());
  try{ LOG = await fetch('../'+GH.paths.log+'?_='+Date.now()).then(r=>r.json()); }catch{ LOG={as_of:PF.as_of,entries:[]} }

  // Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©
  document.getElementById('chipDate').textContent='Ø§Ù„ØªØ§Ø±ÙŠØ®: '+new Date(PF.as_of||Date.now()).toLocaleDateString('ar-EG',{day:'numeric',month:'long',year:'numeric'});
  document.getElementById('sessionDate').value=(PF.as_of||new Date().toISOString().slice(0,10));

  // KPIs
  document.getElementById('kpis').innerHTML = `
    <div class="kpi"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©</span><b>${fmt(PF.portfolio_value)}</b></div>
    <div class="kpi"><span>ØªØºÙŠØ± Ø§Ù„ÙŠÙˆÙ…</span><b class="${PF.day_change>=0?'pos':'neg'}">${fmt(PF.day_change)} (${pct(PF.day_change_pct)})</b></div>
  `;

  // Ø£ÙØ¶Ù„/Ø£Ø¶Ø¹Ù
  const sorted = (PF.positions||[]).slice().sort((a,b)=>(b.pnl_pct||0)-(a.pnl_pct||0));
  document.getElementById('best').textContent = sorted[0]? `${sorted[0].ticker} ${pct(sorted[0].pnl_pct)}` : 'â€”';
  document.getElementById('worst').textContent= sorted.at(-1)? `${sorted.at(-1).ticker} ${pct(sorted.at(-1).pnl_pct)}` : 'â€”';

  // Ø¬Ø¯ÙˆÙ„
  const totalVal = (PF.positions||[]).reduce((a,b)=>a+(+b.market_value||0),0)||1;
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = (PF.positions||[]).map(p=>{
    const w = ((+p.market_value||0)/totalVal*100);
    const act = decideAction(p,w);
    return `
      <tr>
        <td><b>${p.ticker}</b></td>
        <td class="small">${p.name||''}</td>
        <td class="small">${p.type||''}</td>
        <td>${fmt(p.units,0)}</td>
        <td>${fmt(p.avg_price)}</td>
        <td>${fmt(p.last)}</td>
        <td>${fmt(p.market_value)}</td>
        <td class="${p.pnl>=0?'pos':'neg'}">${fmt(p.pnl)}</td>
        <td class="${p.pnl_pct>=0?'pos':'neg'}">${pct(p.pnl_pct)}</td>
        <td><span class="badge ${act.cls}">${act.tag}</span> <span class="small">ÙˆØ²Ù† ${fmt(w)}%</span></td>
      </tr>`;
  }).join('');

  // ØªÙˆØ²ÙŠØ¹
  const labels=(PF.positions||[]).map(x=>x.ticker);
  const data=(PF.positions||[]).map(x=>+x.market_value||0);
  if(window.allocChart) window.allocChart.destroy();
  window.allocChart = new Chart(document.getElementById('alloc').getContext('2d'),{
    type:'doughnut',
    data:{labels,datasets:[{data,borderWidth:0}]},
    options:{plugins:{legend:{display:false}},cutout:'60%'}
  });
  const total=data.reduce((a,b)=>a+b,0)||1;
  document.getElementById('legend').innerHTML = labels.map((l,i)=>`${l}: ${fmt(data[i]/total*100)}%`).join(' â€¢ ');

  // Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØµÙŠØ§Øª (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¯ÙŠÙƒ: COMI ØªØ¹Ø²ÙŠØ²ØŒ BMM ØªØ¹Ø²ÙŠØ² Ø¨Ø³ÙŠØ·ØŒ BSB Ù…Ø±Ø§Ù‚Ø¨Ø©ØŒ ABR Ø§Ø­ØªÙØ§Ø¸)
  const recs = [];
  (PF.positions||[]).forEach(p=>{
    const w=((+p.market_value||0)/totalVal*100);
    const a=decideAction(p,w).tag;
    let text='';
    if(p.ticker==='COMI') text='ØªØ¹Ø²ÙŠØ² ØªØ¯Ø±ÙŠØ¬ÙŠ Ø¨Ù‚ÙŠÙ…Ø© ~400 Ø¬.Ù… Ø­ÙˆÙ„ 107â€“108';
    else if(p.ticker==='BMM') text='ØªØ¹Ø²ÙŠØ² Ø¨Ø³ÙŠØ· ~200 Ø¬.Ù… Ù„Ø±ÙØ¹ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¢Ù…Ù†';
    else if(p.ticker==='BSB') text='Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆÙ† Ø¨ÙŠØ¹Ø› Ø®ÙØ¶ Ù„Ùˆ ÙƒØ³Ø± 142 Ø¨Ø¥ØºÙ„Ø§Ù‚';
    else if(p.ticker==='ABR') text='Ø§Ø­ØªÙØ§Ø¸ Ø·ÙˆÙŠÙ„ Ø§Ù„Ø£Ø¬Ù„Ø› Ø¥Ø¹Ø§Ø¯Ø© Ù…ÙˆØ§Ø²Ù†Ø© ÙÙ‚Ø· Ø¥Ù† ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆØ²Ù† 20%';
    else text=a;
    recs.push(`<div class="kpi"><span><b>${p.ticker}</b> â€” ${a}</span><span class="small">${text}</span></div>`);
  });
  document.getElementById('recs').innerHTML = recs.join('');
}

async function saveLog(){
  const date = document.getElementById('sessionDate').value || new Date().toISOString().slice(0,10);
  const note = (document.getElementById('note').value||'').trim() || 'ØªØ­Ø¯ÙŠØ« Ø¢Ù„ÙŠ Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„.';
  const pf = PF;

  // Ø­Ø¶Ù‘Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…
  const best = (pf.positions||[]).slice().sort((a,b)=>(b.pnl_pct||0)-(a.pnl_pct||0))[0]?.ticker||'';
  const worst= (pf.positions||[]).slice().sort((a,b)=>(a.pnl_pct||0)-(b.pnl_pct||0))[0]?.ticker||'';
  const entry={date,portfolio_value:+(pf.portfolio_value||0),day_change:+(pf.day_change||0),
               day_change_pct:+(pf.day_change_pct||0),best_stock:best,worst_stock:worst,notes:note};

  // Ø§Ù‚Ø±Ø£ Ø³Ø¬Ù„ GitHub Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ sha
  try{
    const {sha,text} = await ghRead(GH.paths.log);
    let obj={as_of:date,entries:[]};
    try{ obj=JSON.parse(text) }catch{}
    const arr=Array.isArray(obj.entries)?obj.entries:[];
    const i=arr.findIndex(e=>e.date===date);
    if(i>=0) arr[i]=entry; else arr.push(entry);
    const newContent = JSON.stringify({as_of:date,entries:arr},null,2);
    await ghWrite(GH.paths.log,newContent,sha,`chore: update daily_log ${date}`);
    alert('ØªÙ… Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù„Ù‰ GitHub âœ…');
  }catch(e){
    if(e.message==='NO_TOKEN') alert('Ø£Ø¯Ø®Ù„ GitHub Token Ø£ÙˆÙ„Ø§Ù‹.');
    else alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub.');
    console.warn(e);
  }
}

document.getElementById('saveLog').addEventListener('click',saveLog);
document.getElementById('btnToken').addEventListener('click',()=>{
  const t=prompt('Ø£Ø¯Ø®Ù„ GitHub Token (scope: repo):',getToken()||'');
  if(t) setToken(t);
  alert(getToken()?'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…':'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸');
});

render();
</script>
</body>
</html>
