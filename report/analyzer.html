<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ù‡Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ â€” Thndr</title>
<link rel="stylesheet" href="../assets/ui.css">
<style>
  :root{--bg:#0b0b0f;--card:#14141b;--soft:#0f1016;--border:#23242c;--txt:#f3f4f6;--muted:#a1a1aa;--good:#22c55e;--bad:#ef4444;--acc:#0ea5e9}
  body{background:var(--bg);color:var(--txt);font-family:"Cairo",Tahoma,Arial,sans-serif}
  .container{max-width:1100px;margin:22px auto;padding:0 16px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .input{background:var(--soft);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--txt);width:100%}
  .input:focus{outline:none;border-color:#2a2f3a}
  label{font-size:12px;color:var(--muted)}
  .tbl{width:100%;border-collapse:collapse;background:var(--soft);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  .tbl th{background:#101118;color:#cbd5e1;font-size:13px}
  .pill{padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
  .up{color:var(--good);background:rgba(34,197,94,.12)}
  .dn{color:var(--bad);background:rgba(239,68,68,.12)}
  .btn--ghost{background:transparent;border:1px dashed var(--border)}
</style>
<script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
<div class="container">

  <div class="row" style="justify-content:space-between">
    <div class="title">ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ù‡Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„</div>
    <div class="row">
      <a class="btn" href="../index.html">ğŸ  Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
      <a class="btn" href="./portfolio_report.html">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</a>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
  <div class="card">
    <div class="grid two">
      <div>
        <label>Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… (Ticker)</label>
        <input class="input" id="ticker" placeholder="COMI / ABR / BMM ..." />
      </div>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
        <input class="input" id="name" placeholder="Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ" />
      </div>
      <div>
        <label>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ù…Ù†</label>
        <input type="number" step="0.01" class="input" id="buyFrom" placeholder="Ù…Ø«Ø§Ù„: 115.00" />
      </div>
      <div>
        <label>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø¥Ù„Ù‰</label>
        <input type="number" step="0.01" class="input" id="buyTo" placeholder="Ù…Ø«Ø§Ù„: 118.00" />
      </div>
      <div>
        <label>ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© (SL)</label>
        <input type="number" step="0.01" class="input" id="sl" placeholder="Ù…Ø«Ø§Ù„: 110.00" />
      </div>
      <div>
        <label>Ø§Ù„Ù‡Ø¯Ù (TP)</label>
        <input type="number" step="0.01" class="input" id="tp" placeholder="Ù…Ø«Ø§Ù„: 130.00" />
      </div>
      <div>
        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ %</label>
        <input type="number" step="0.1" class="input" id="riskPct" value="1.0" />
      </div>
      <div>
        <label>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø¬.Ù…)</label>
        <input type="number" step="0.01" class="input" id="capital" value="10000" />
      </div>
      <div style="grid-column:1/-1">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input class="input" id="note" placeholder="Ù†Ù‚Ø·Ø© Ø¯Ø¹Ù…/Ù…Ù‚Ø§ÙˆÙ…Ø©ØŒ Ø®Ø¨Ø±ØŒ Ø³ÙŠÙˆÙ„Ø©..." />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnCalc">ğŸ§® Ø­Ø³Ø§Ø¨</button>
      <button class="btn" id="btnAdd">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button class="btn btn--soft" id="btnTV">ğŸ“ˆ ÙØªØ­ Ø§Ù„Ø±Ø³Ù…</button>
      <button class="btn btn--soft" id="btnSave">ğŸ’¾ Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub</button>
      <button class="btn btn--ghost" id="btnDownload">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ JSON</button>
      <label class="btn btn--soft" for="fileUp">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</label>
      <input id="fileUp" type="file" accept="application/json" style="display:none">
    </div>

    <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
    <div class="row" id="calcBox" style="margin-top:10px;display:none">
      <div class="pill up" id="rr">R/R: â€”</div>
      <div class="pill" id="riskValue" style="background:#1f2937">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©: â€”</div>
      <div class="pill" id="qty" style="background:#1f2937">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: â€”</div>
      <div class="pill" id="breakeven" style="background:#1f2937">Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„: â€”</div>
      <div class="pill" id="exp" style="background:#1f2937">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: â€”</div>
    </div>
  </div>

  <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
  <div class="card">
    <div class="small muted" style="margin-bottom:6px">TradingView â€” EGX</div>
    <div id="tv" style="height:420px"></div>
  </div>

  <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø±Ø´Ø­Ø©</div>
      <div class="small muted">Ø§Ù„Ù…ØµØ¯Ø±: data/watchlist.json</div>
    </div>
    <table class="tbl" id="tbl">
      <thead>
        <tr>
          <th>Ø§Ù„Ø³Ù‡Ù…</th><th>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>SL</th><th>TP</th>
          <th>R/R</th><th>Ù…Ø®Ø§Ø·Ø±Ø© Ø¬.Ù…</th><th>Qty</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* ======= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯) ======= */
const GH = { owner:"temsah2002-arch", repo:"Thndr-report-temsah", branch:"main",
  paths:{ watch:"data/watchlist.json" } };
const b64 = s => btoa(unescape(encodeURIComponent(s)));
const deB64 = s => decodeURIComponent(escape(atob(s)));
const getToken = ()=> localStorage.getItem("gh_token") || "";
/* Ù‚Ø±Ø§Ø¡Ø©/ÙƒØªØ§Ø¨Ø© GitHub */
async function ghRead(path){
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}?ref=${GH.branch}`;
  const r=await fetch(url,{headers:{Accept:"application/vnd.github+json"}}); if(!r.ok) throw new Error("read failed");
  const j=await r.json(); return {sha:j.sha, text:deB64(j.content||"")};
}
async function ghWrite(path,content,sha,message){
  const token=getToken(); if(!token) throw new Error("NO_TOKEN");
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
  const body={message, content:b64(content), sha, branch:GH.branch};
  const r=await fetch(url,{method:"PUT",headers:{Accept:"application/vnd.github+json","Authorization":"Bearer "+token},body:JSON.stringify(body)});
  if(!r.ok){ throw new Error(await r.text()); }
  return r.json();
}

/* ========== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ========== */
let LIST = { items: [] };

/* ØªØ­Ù…ÙŠÙ„ watchlist.json */
async function loadList(){
  try{
    LIST = await fetch('../data/watchlist.json?_='+Date.now()).then(r=>r.json());
    if(!Array.isArray(LIST.items)) LIST.items=[];
  }catch{ LIST = {items:[]} }
  renderTable();
}

/* Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function renderTable(){
  const tb=document.querySelector('#tbl tbody');
  tb.innerHTML = (LIST.items||[]).map((x,i)=>{
    const rr = ((x.tp-x.buy_to)/(x.buy_to-x.sl)).toFixed(2);
    const riskValue = ((+x.risk_pct||1)/100*(+x.capital||0));
    const qty = Math.max(0, Math.floor(riskValue/Math.max(0.01,(x.buy_to-x.sl))));
    return `<tr>
      <td><b>${x.ticker}</b><br><span class="small muted">${x.name||''}</span></td>
      <td>${fmt(x.buy_from)} â€“ ${fmt(x.buy_to)}</td>
      <td>${fmt(x.sl)}</td>
      <td>${fmt(x.tp)}</td>
      <td><span class="pill ${rr>=2?'up':'dn'}">${rr}</span></td>
      <td>${fmt(riskValue)}</td>
      <td>${qty}</td>
      <td class="small">${x.note||''}</td>
      <td><button class="btn btn--soft" onclick="editItem(${i})">âœï¸</button>
          <button class="btn btn--ghost" onclick="delItem(${i})">ğŸ—‘ï¸</button></td>
    </tr>`;
  }).join('');
}
function fmt(n){return new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2}).format(+n||0)}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ */
function calc(){
  const buyFrom=+g('buyFrom'), buyTo=+g('buyTo'), sl=+g('sl'), tp=+g('tp');
  const riskPct=+g('riskPct'), capital=+g('capital');
  if(!buyTo||!sl||buyTo<=sl){ alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©'); return; }
  const riskPerShare = buyTo - sl;
  const rr = (tp - buyTo) / riskPerShare;
  const riskValue = (riskPct/100)*capital;
  const qty = Math.max(0, Math.floor(riskValue/Math.max(0.01,riskPerShare)));
  const exp = qty*(tp-buyTo);
  const be = buyTo; // simplification
  S('calcBox').style.display='flex';
  S('rr').textContent = 'R/R: ' + rr.toFixed(2);
  S('riskValue').textContent = 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©: ' + fmt(riskValue);
  S('qty').textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ' + qty;
  S('breakeven').textContent = 'Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„: ' + fmt(be);
  S('exp').textContent = 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ' + fmt(exp);
}
function add(){
  const item = {
    ticker: g('ticker').toUpperCase().trim(),
    name: g('name'),
    buy_from:+g('buyFrom'), buy_to:+g('buyTo'),
    sl:+g('sl'), tp:+g('tp'),
    risk_pct:+g('riskPct'), capital:+g('capital'),
    note:g('note')
  };
  if(!item.ticker||!item.buy_to||!item.sl){ alert('Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…ØŒ Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ ÙˆÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©.'); return; }
  const i = LIST.items.findIndex(x=>x.ticker===item.ticker);
  if(i>=0) LIST.items[i]=item; else LIST.items.push(item);
  renderTable(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¤Ù‚ØªÙ‹Ø§ â€” Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ JSON.');
}
function editItem(i){
  const x=LIST.items[i];
  set('ticker',x.ticker); set('name',x.name||''); set('buyFrom',x.buy_from);
  set('buyTo',x.buy_to); set('sl',x.sl); set('tp',x.tp);
  set('riskPct',x.risk_pct); set('capital',x.capital); set('note',x.note||'');
  window.scrollTo({top:0,behavior:'smooth'});
}
function delItem(i){ LIST.items.splice(i,1); renderTable(); }

/* Ø­ÙØ¸ */
async function saveGH(){
  try{
    const {sha} = await ghRead(GH.paths.watch);
    const json = JSON.stringify(LIST,null,2);
    await ghWrite(GH.paths.watch, json, sha, 'chore: update watchlist');
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub âœ…');
  }catch(e){
    if(String(e).includes('NO_TOKEN')){ alert('Ø§Ø¶Ø¨Ø· Ø§Ù„Ù€Token Ù…Ù† Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø£ÙˆÙ„Ù‹Ø§.'); }
    else{ console.warn(e); alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ GitHub.'); }
  }
}
function download(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(LIST,null,2)],{type:'application/json'}));
  a.download='watchlist.json'; a.click();
}
function upload(file){
  const fr=new FileReader(); fr.onload=()=>{
    try{ LIST = JSON.parse(fr.result); if(!Array.isArray(LIST.items)) LIST.items=[]; renderTable(); }
    catch{ alert('ØµÙŠØºØ© Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); }
  }; fr.readAsText(file,'utf-8');
}

/* Ø£Ø¯ÙˆØ§Øª */
function g(id){return document.getElementById(id).value}
function set(id,v){document.getElementById(id).value=v}
function S(id){return document.getElementById(id)}

/* TradingView */
function openTV(){
  const sym = (g('ticker')||'EGX30').toUpperCase().trim();
  S('tv').innerHTML='';
  if(window.TradingView){
    new TradingView.widget({
      container_id:"tv", autosize:true,
      symbol: sym.includes(':')? sym : `EGX:${sym}`,
      interval:"60", timezone:"Africa/Cairo", theme:"dark", style:"1",
      hide_top_toolbar:false, withdateranges:true, hide_legend:true,
      hide_volume:false, studies:[], locale:"ar"
    });
  }
}

/* Ø£Ø­Ø¯Ø§Ø« */
document.getElementById('btnCalc').addEventListener('click', calc);
document.getElementById('btnAdd').addEventListener('click', add);
document.getElementById('btnTV').addEventListener('click', openTV);
document.getElementById('btnSave').addEventListener('click', saveGH);
document.getElementById('btnDownload').addEventListener('click', download);
document.getElementById('fileUp').addEventListener('change', e=> upload(e.target.files[0]));

/* ØªØ´ØºÙŠÙ„ */
loadList(); openTV();
</script>
</body>
</html>
