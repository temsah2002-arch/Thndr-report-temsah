<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØªÙ‚Ø±ÙŠØ± Ù…Ø­ÙØ¸Ø© Ø«Ø§Ù†Ø¯Ø±</title>
<style>
  :root { --bg:#0b0b0f; --card:#14141b; --text:#f3f4f6; --muted:#a1a1aa;
          --up:#16a34a; --down:#ef4444; --accent:#f59e0b; --border:#22232b; }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Cairo",Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.8}
  .container{max-width:980px;margin:24px auto;padding:0 16px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  .title{font-size:28px;font-weight:800}
  .date-chip{padding:6px 12px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;margin:12px 0}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0f1016;border:1px solid var(--border);border-radius:14px;padding:14px}
  .kpi h4{margin:0 0 6px;font-size:14px;color:var(--muted)}
  .kpi .val{font-size:22px;font-weight:700}
  .pos-table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px}
  .pos-table th,.pos-table td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:right}
  .pos-table th{background:#101219;color:#cbd5e1;font-size:13px}
  .pos-table tr:hover td{background:#101018}
  .badge{padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
  .up{color:var(--up);background:rgba(22,163,74,.12)}
  .down{color:var(--down);background:rgba(239,68,68,.12)}
  .muted{color:var(--muted)}
  .section-title{font-size:20px;margin:0 0 10px}
  .recs{display:grid;grid-template-columns:1fr;gap:10px}
  .rec{border:1px dashed var(--border);border-radius:12px;padding:12px 14px;background:#0f1016}
  .rec h4{margin:0 0 6px;font-size:16px}
  .footer{text-align:center;color:var(--muted);padding:18px 6px;font-size:12px}
  .pill{background:#1f2937;color:#e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px}
  @media(min-width:720px){.recs{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">ØªÙ‚Ø±ÙŠØ± Ù…Ø­ÙØ¸Ø© Ø«Ø§Ù†Ø¯Ø±</div>
      <div id="date-chip" class="date-chip">Ø§Ù„ØªØ§Ø±ÙŠØ®: â€”</div>
    </div>

    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h4>
          <div id="pf_val" class="val">â€”</div>
          <div class="muted">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø­ÙØ¸Ø©</div>
        </div>
        <div class="kpi">
          <h4>ØªØºÙŠØ± Ø§Ù„ÙŠÙˆÙ…</h4>
          <div class="val"><span id="day_badge" class="badge">â€”</span></div>
          <div class="muted">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø£Ù…Ø³</div>
        </div>
        <div class="kpi">
          <h4>Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</h4>
          <div class="val"><span id="best-pill" class="pill">â€”</span></div>
          <div id="best-name" class="muted">â€”</div>
        </div>
        <div class="kpi">
          <h4>Ø£Ø¶Ø¹Ù Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</h4>
          <div class="val"><span id="worst-pill" class="pill">â€”</span></div>
          <div id="worst-name" class="muted">â€”</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
      <table class="pos-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ø³Ù‡Ù… / Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</th>
            <th>Ø§Ù„Ù…ÙƒØ³Ø¨ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
            <th>Ù…Ù„Ø­ÙˆØ¸Ø©</th>
          </tr>
        </thead>
        <tbody id="pos-body"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="section-title">Ø§Ù„ØªÙˆØµÙŠØ§Øª</div>
      <div class="recs">
        <div class="rec">
          <h4 id="hold-line">âœ… Ø§Ø­ØªÙØ§Ø¸: â€”</h4>
          <div class="muted">Ø§ØªØ¬Ø§Ù‡ ØªØµØ§Ø¹Ø¯ÙŠ Ø«Ø§Ø¨Øª ÙˆÙ…Ø®Ø§Ø·Ø±Ø© Ù…Ù†Ø®ÙØ¶Ø©.</div>
        </div>
        <div class="rec">
          <h4 id="watch-line">ğŸ” Ù…Ø±Ø§Ù‚Ø¨Ø©: â€”</h4>
          <div class="muted">Ù…Ø±Ø§ÙƒØ² Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø³Ø¨ Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙˆÙ‚.</div>
        </div>
      </div>
    </div>

    <div class="footer" id="footer-date">â€”</div>
  </div>

<script>
const fmt = (n,d=2)=> new Intl.NumberFormat('ar-EG',{maximumFractionDigits:d}).format(+n||0);
const pct = n => ( (n>=0?'+':'') + (Number(n)||0).toFixed(2) + '%' );

async function loadReport(){
  // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const pf = await fetch('../data/portfolio.json?_=' + Date.now()).then(r=>r.json());
  let log = null;
  try{
    const j = await fetch('../data/daily_log.json?_=' + Date.now()).then(r=>r.json());
    // entries Ù‚Ø¯ ØªÙƒÙˆÙ† Array Ø£Ùˆ ÙƒØ§Ø¦Ù†Ø› Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ù„Ù…ØµÙÙˆÙØ© ÙˆØ§Ø®ØªØ± Ø§Ù„Ø£Ø­Ø¯Ø«
    let entries = [];
    if (Array.isArray(j.entries)) entries = j.entries;
    else entries = Object.entries(j.entries||{}).map(([date,obj])=>({date,...obj}));
    log = entries.filter(e=>e.date).sort((a,b)=>new Date(b.date)-new Date(a.date))[0] || null;
  }catch(e){ /* Ù„Ø§ Ù…Ø´ÙƒÙ„Ø©ØŒ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ portfolio.json */ }

  // Ø­Ø¯Ù‘Ø« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø´Ø§Ø±Ø© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ÙÙˆØªØ±
  const d = (log && log.date) || pf.as_of || new Date().toISOString().slice(0,10);
  const human = new Date(d).toLocaleDateString('ar-EG',{day:'numeric',month:'long',year:'numeric'});
  document.getElementById('date-chip').textContent = 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + human;
  document.title = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø­ÙØ¸Ø© Ø«Ø§Ù†Ø¯Ø± - ' + human;
  document.getElementById('footer-date').textContent = 'Ø£ÙØ¹Ø¯Ù‘ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ø¹ØªÙ…Ø§Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø¨ÙŠÙ‚ Ø«Ø§Ù†Ø¯Ø±. â€” ' + human;

  // KPIs
  document.getElementById('pf_val').textContent = fmt(pf.portfolio_value) + ' Ø¬.Ù…';
  const dayClass = (pf.day_change>=0)?'badge up':'badge down';
  const dayText  = (pf.day_change>=0 ? 'â–² ' : 'â–¼ ') + fmt(pf.day_change) + ' (' + pct(pf.day_change_pct) + ')';
  const dayBadge = document.getElementById('day_badge');
  dayBadge.className = dayClass;
  dayBadge.textContent = dayText;

  // Ø£ÙØ¶Ù„/Ø£Ø³ÙˆØ£ (Ù…Ù† Ø§Ù„Ù„ÙˆØ¬ Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…Ø±Ø§ÙƒØ²)
  const positions = pf.positions||[];
  const byTicker = t=>positions.find(p=>p.ticker===t);
  let bestTicker = log?.best_stock;
  let worstTicker = log?.worst_stock;
  if(!bestTicker || !worstTicker){
    // Ø§Ø­Ø³Ø¨ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (pnl_pct)
    const sorted = [...positions].sort((a,b)=> Number(b.pnl_pct||0) - Number(a.pnl_pct||0));
    if(!bestTicker && sorted[0]) bestTicker = sorted[0].ticker;
    if(!worstTicker && sorted[sorted.length-1]) worstTicker = sorted[sorted.length-1].ticker;
  }
  const best = byTicker(bestTicker) || {ticker:bestTicker||'â€”', name:'', pnl_pct:0};
  const worst = byTicker(worstTicker) || {ticker:worstTicker||'â€”', name:'', pnl_pct:0};
  document.getElementById('best-pill').textContent  = (best.ticker||'â€”') + ' ' + pct(best.pnl_pct||0);
  document.getElementById('best-name').textContent  = best.name||'â€”';
  document.getElementById('worst-pill').textContent = (worst.ticker||'â€”') + ' ' + pct(worst.pnl_pct||0);
  document.getElementById('worst-name').textContent = worst.name||'â€”';

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²
  const tbody = document.getElementById('pos-body');
  tbody.innerHTML = positions.map(p=>{
    const good = Number(p.pnl_pct)>=0;
    return `
      <tr>
        <td>${p.name||''} (${p.ticker})</td>
        <td>${fmt(p.market_value)} Ø¬.Ù…</td>
        <td><span class="badge ${good?'up':'down'}">${good?'+':''}${fmt(p.pnl)}</span></td>
        <td><span class="${good?'up':'down'}">${pct(p.pnl_pct)}</span></td>
        <td>${good ? 'Ø§ØªØ¬Ø§Ù‡ ØªØµØ§Ø¹Ø¯ÙŠ/Ø§Ø­ØªÙØ§Ø¸' : 'Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· ÙˆÙ‚Ù'}</td>
      </tr>`;
  }).join('');

  // ØªÙˆØµÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (Ø§Ø­ØªÙØ§Ø¸ = Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ†ØŒ Ù…Ø±Ø§Ù‚Ø¨Ø© = Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†)
  const winners = positions.filter(p=>Number(p.pnl_pct)>=0).map(p=>p.ticker);
  const losers  = positions.filter(p=>Number(p.pnl_pct)<0).map(p=>p.ticker);
  document.getElementById('hold-line').textContent  = 'âœ… Ø§Ø­ØªÙØ§Ø¸: ' + (winners.join(' - ') || 'â€”');
  document.getElementById('watch-line').textContent = 'ğŸ” Ù…Ø±Ø§Ù‚Ø¨Ø©: ' + (losers.join(' - ') || 'â€”');
}

// Ø§Ø¨Ø¯Ø£
loadReport();
</script>
</body>
</html>
